<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRPG Offline Reference</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f6b3f">

<style>
/* -------------------- Root Variables -------------------- */
:root {
  --green:#2f6b3f;
  --gray:#6b6b6b;
  --bg:#f4f4f4;
  --text:#222;
}

/* -------------------- Layout -------------------- */
body {
  margin:0;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background: var(--bg);
  color: var(--text);
  display:flex;
  height:100vh;
}

aside {
  width:300px;
  background:#fff;
  border-right:1px solid #ccc;
  overflow-y:auto;
}

aside h2,h3 { margin:0; padding:0.75rem 1rem; border-bottom:1px solid #ddd; }

nav button {
  width:100%;
  border:none;
  background:none;
  padding:0.6rem 1rem;
  text-align:left;
  cursor:pointer;
  border-bottom:1px solid #eee;
}
nav button:hover { background:#f0f0f0; }
nav .nested { padding-left:1.5rem; }

main {
  flex:1;
  overflow-y:auto;
  padding:1.5rem;
}

.pdf-pages canvas {
  display:block;
  margin:1rem auto;
  max-width:100%;
  box-shadow:0 0 4px rgba(0,0,0,.2);
}

textarea {
  width:100%;
  min-height:80px;
  margin-top:1rem;
  padding:0.5rem;
}

.bookmark {
  float:right;
  cursor:pointer;
  font-size:1.2rem;
}
</style>
</head>

<body>

<!-- -------------------- Sidebar -------------------- -->
<aside>
  <h2>IRPG</h2>
  
  <h3>Recent</h3>
  <nav id="recentNav"></nav>
  
  <h3>Bookmarks</h3>
  <nav id="bookmarkNav"></nav>
  
  <h3>Table of Contents</h3>
  <nav id="tocNav"></nav>
</aside>

<!-- -------------------- Main Content -------------------- -->
<main>
  <div class="pdf-pages"></div>
  <textarea placeholder="Notes..."></textarea>
</main>

<script type="module">
import * as pdfjsLib from './pdf.mjs';

// -------------------- PDF.js Setup --------------------
pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';
const pdfUrl = 'irpg.pdf';
let pdfDoc = null;

// DOM Elements
const tocNav = document.getElementById('tocNav');
const recentNav = document.getElementById('recentNav');
const bookmarkNav = document.getElementById('bookmarkNav');
const pdfContainer = document.querySelector('.pdf-pages');
const notesArea = document.querySelector('textarea');

// -------------------- SECTION PAGES --------------------
// Edit this object to change page ranges per IRPG section.
// Key = Section Title, Value = Array of 1-indexed pages
const SECTION_PAGES = {
  "Size-Up Report": [5,6,7],
  "Risk Management Process": [8,9,10],
  "LCES": [11,12,13],
  "Downhill Fireline Construction": [14,15],
  // Add additional IRPG sections here
};

// -------------------- Load PDF and Build TOC --------------------
async function loadPDF() {
  pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
  
  // Try to use PDF outline
  const outline = await pdfDoc.getOutline();
  buildTOC(outline, tocNav);
}

// -------------------- Render Multiple Pages --------------------
async function renderPages(pageNumbers) {
  pdfContainer.innerHTML = '';
  for(const p of pageNumbers) {
    const page = await pdfDoc.getPage(p);
    const viewport = page.getViewport({ scale: 1.5 });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    pdfContainer.appendChild(canvas);
    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
  }
}

// -------------------- Build Table of Contents --------------------
function buildTOC(items, container, level=0) {
  if(!items) return;

  items.forEach(item => {
    const btn = document.createElement('button');
    btn.textContent = item.title;
    if(level>0) btn.classList.add('nested');

    // -------------------- Click TOC Item --------------------
    btn.onclick = async () => {
      let pages = SECTION_PAGES[item.title];

      // Fallback if section not in SECTION_PAGES
      if(!pages && item.dest) {
        const dest = await pdfDoc.getDestination(item.dest);
        if(dest && typeof dest[0] === 'number') pages = [dest[0]+1];
        else pages = [1];
      }

      renderPages(pages);
      addRecent(item.title);
    };

    container.appendChild(btn);

    // Recursively add nested outline items
    if(item.items && item.items.length) buildTOC(item.items, container, level+1);
  });
}

// -------------------- Recent Sections --------------------
function addRecent(title) {
  let recent = JSON.parse(localStorage.getItem('recent')||'[]');
  recent = recent.filter(x=>x!==title);
  recent.unshift(title);
  recent = recent.slice(0,5); // Keep last 5
  localStorage.setItem('recent',JSON.stringify(recent));
  renderRecent();
}

function renderRecent() {
  recentNav.innerHTML='';
  (JSON.parse(localStorage.getItem('recent')||'[]')).forEach(title=>{
    const btn = document.createElement('button');
    btn.textContent = title;
    btn.onclick = () => {
      const tocBtn = Array.from(tocNav.querySelectorAll('button')).find(b=>b.textContent===title);
      if(tocBtn) tocBtn.click();
    };
    recentNav.appendChild(btn);
  });
}

// -------------------- Bookmarks --------------------
function toggleBookmark(title) {
  let bookmarks = JSON.parse(localStorage.getItem('bookmarks')||'[]');
  bookmarks.includes(title) ? bookmarks = bookmarks.filter(x=>x!==title) : bookmarks.push(title);
  localStorage.setItem('bookmarks',JSON.stringify(bookmarks));
  renderBookmarks();
}

function renderBookmarks() {
  bookmarkNav.innerHTML='';
  (JSON.parse(localStorage.getItem('bookmarks')||'[]')).forEach(title=>{
    const btn = document.createElement('button');
    btn.textContent = title;
    btn.onclick = () => {
      const tocBtn = Array.from(tocNav.querySelectorAll('button')).find(b=>b.textContent===title);
      if(tocBtn) tocBtn.click();
    };
    bookmarkNav.appendChild(btn);
  });
}

// -------------------- Notes --------------------
notesArea.value = localStorage.getItem('notes')||'';
notesArea.addEventListener('input',()=>localStorage.setItem('notes',notesArea.value));

// -------------------- Initialize --------------------
loadPDF();
renderRecent();
renderBookmarks();

// -------------------- Service Worker --------------------
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>
